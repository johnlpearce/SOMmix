---
title: "sommixUSL"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{sommixUSL}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r load package}
library(sommix)
```
#Introduction
## Overview
The **R** package *sommix* can be used for application of the *self-organizing map (SOM)* algorithm for analyses of complex, highdimensional data. The development of *sommix* is motivated by environmental health and epidemiology settings where exposure assessment and health effects studies often encompass multiple risk factors involving complex environmental mixtures.  


This document *sommixUSL* is the first vignette documenting the package. Its aim is to describe and illustrate an unsupervised statistical learning (USL) form of SOM. The analyses is similar cluster analysis as the overarching objective is to identify exposure profiles using a well established synthetic data example. 

Please send any comments, suggestions, or bug reports to pearcejo@musc.edu.

## Self-Organizing Maps
SOM is an artificial neural network (ANN) that applies competitive learning with an integrated neighborhood function in order to discover and ‘map’ representative features within multivariate data (Kohonen 2013). The ‘map’ is a low-dimensional representation that is used to illustrate discovered profiles in a spatially organized way. This unique ‘self-organizing’ feature ensures that the resulting mapping provides an arrangement of categories where neighboring profiles are similar. This allows for a larger number of classes to be more easily understood, offering users the ability to represent exposures as a high-resolution continuum of categorizations, a key distinction from the discrete clusters/factors often produced through more traditional methods. 

#Example Data
*sommix* includes synthetic data from a recent NIEHS Mixtures Workshop, which can be obtained here:
https://www.niehs.nih.gov/about/events/pastmtg/2015/statistical/index.cfm


For this example we use Data Set 1: Chemical Mixture Simulated Data. These synthetic data can be considered as the results of a prospective cohort epidemiologic study. The outcome cannot cause the exposures (as might occur in a cross-sectional study).Correlations between exposure variables can be thought of as caused by common sources or modes of exposure.The nuisance variable Z can be assumed to be a potential confounder and not a collider.

Number of records: 500
Data per subject: Y, X1, X2, X3, X4, X5, X6, X7, Z
Y = outcome data, 1 continuous variable
X1 - X7= exposure data, 7 continuous variables
Z: potential confounder, binary

Additional information:
For purposes of Data Set #1, there is no loss to follow up, missing or censored data, mismeasurement of the variables (Y, Xi, Z), or many of the other potential biases. 
One may also assume that the seven exposure variables X1, X7 and Z are not intermediate variables and not colliders. 
There are no other confounders or effect measure modifiers. Random noise has been added to the outcome variable.

##Load Example Data
```{r dataset, echo=TRUE}
data(dataset1)
summary(dataset1)
```

#Methodology and Application
## Selecting Training Data
The first step in our analyses is to identify appropriate training data. This application focuses on unsupervised learning and thus we subset our data to only include the exposure matrix (X).

```{r datatrn,  echo=FALSE}
data.trn<-dataset1[,3:9] 
summary(data.trn)
```

## Feature scaling  
Data sets often contain multiple features spanning varying magnitudes, ranges, and units. This can be problematic for many multivariate techniques and thus feature scaling in often necessary. In this example, we employ data standardization as our method. In brief, standardization performs scaling where the values are centered around the mean with a unit standard deviation. This means that the mean of each variable becomes zero and the resultant distribution has a unit standard deviation.      

```{r datascale, echo=TRUE}
data.trn.sc<-scale(data.trn, center=TRUE, scale=TRUE)
summary(data.trn.sc)
```

## Exploratory Data Analysis
### Independent Variable Assessment 
Before conducting mixtures analysis it is important to understand the behaviour and properties of each candidate variable. The *vareval* function is designed to enhance understanding of the distribution of each variable in your data, the relative variability, and the proportion of missing and zero values. Boxplots and frequency plots are provided.

```{r vareval, echo=TRUE}
vareval(data.trn)
```
### Correlation Structure
Data correlations play an important role in mixtures analyses as environmental exposure data are often strongly correlated. The *coreval* function is designed to enhance understanding of correlation among variables. A correlation matrix is returned and values are plotted on a correlogram.   

```{r coreval, echo=TRUE}
coreval(data.trn)
```

### Principal Component Analysis (PCA) 
Understanding the primary modes of variance (a.k.a., principal components) in a data set can be helpful determing the overall complexity of the data and identify important patterns covariation. Here we obtain such information using Principal Component Analysis (PCA). The *pcaeval* applies PCA and produces diagnostic plots that seek to identify important variance-covariance structure among variables. 

```{r pcaeval, echo=TRUE}
pcaeval(data.trn.sc)
```

### Analysis of Grouping Stucture 
Studies of environmental exposure often seek to group participants based on similar exposure patterns (e.g., high vs. low). The *grpeval* function is designed assist with this task as it employs traditional cluster analysis via kmeans in order to assess grouping/clustering structure in the data.  

```{r grpeval, echo=TRUE}
grpeval(data.trn.sc, kmx=30) 
```

#Applying Self-Organizing Map (SOM)
## Selecting Map Size
The *mapsize* function is designed to enhance understanding of how map size can be used to capture different characteristics of our exposure data. In this example, we seek to build a SOM that has the benefits of both PCA and clustering approaches. More specifically, we desire that our model explains variability as well as PCA but retains the interpretability of clustering profiles. Prior outputs reveal that the first two PCs explain ~60% of the variabity in our data and that no evidence of obvious clusters in the data exist. However, we see the within/between ratio drops below 1 after 3 groupings, a measure that indicates better group definition occurs after this point. Given this, we restrict the potential range of solutions using a minimum of 2 classes up to a maximum of 30 classes as potential sample size is a concern.  

```{r mapsize, echo=TRUE}
mapsize(data.trn.sc, kmx=10)
```

Based on our targets we see that a SOM with 9 profiles explains ~60 of the variability (Panel a) in our data and that our model fit criteria show 'elbowing' (b-d). Class cohesion and frequencies  We use this size as our example below.  

##Fitting a SOM
Here we fit a 3x3 SOM to our synthetic exposure data using the *sommix* function, which is a wrapper for *som* provided by the *kohonen*. Modifications include optimization of a initial seed values and determination of the number of learning iterations based on map size. For more detail on *kohonen* see: https://cran.r-project.org/web/packages/kohonen/index.html

```{r sommix, echo=TRUE}
sommod<-sommix(data.trn.sc, somx=3, somy=3, seedopt="Y", nstarts=10) 
print(summary(sommod))
```

###Summarizing SOM Output
Summarizing the output of a SOM is critical for interpretation. Aspects of interest here are overall model fit, potential sample size, class cohesion and seperation, and the representativeness (i.e., relative importance) of each component of the map. 

```{r somsumm, echo=TRUE}
summ<-sommix_summ(som_obj=sommod)
names(summ)
head(summ$trn_data)
```

###Plotting Results
We present a 3X3 SOM that illustrates 9 (synthetic) Exposure Mixture Types (EMTs) that capture the range of exposure scenarios that occurred in the synthetic data. Each BMT is characterized by a profile which reflects a defined exposure category, where bar plots illustrate the magnitudes via the median (± interquartile range) of exposure concentrations. The y-axis reflects the standardized scaling and where zero reflects the mean and values reflect a 1 standard deviation unit. (This is a standard approach used to provide comparative measures across differing chemical classes and reporting units.) Labels reflect SOM grid coordinates and are presented above each profile in brackets [x,y] and the relative frequencies (%) of classification assignments are in the lower right corner. 

```{r somplots, echo=TRUE}
sommix_bar(som_obj=sommod, varnames=NULL, colormod=NULL,
                     nodelab=TRUE, labtype="XYs", labsize=1,
                     addFreq=TRUE, freqtype="frq", freqsize=0.75,
                     legsymsize=2, leglabsize=1, legtxtlas=2,
                     barstat="MED")
```

###Assessing Map Fit
Here we provide a range of plots designed to improve understanding of the profiles discovered by our SOM model and facilitate comparision to more traditional techiques. Panel (a) presents a parallel coordinates plot of SOM profile results in order visualize differences in the individual components. Each vertical bar represents a variable axis where minimum values are on the bottom and maximum values are on top. A line is then used to connect component values for each profile. Panel (b) presents a multidimensional scaling plot that allows visualization of how well the SOM profile results span the original data space and how they compare to profiles generated from kmeans and Ward's heirarchical clustering. Panel (c) presents a Sammon's mapping of SOM profiles that effectively visualizes the the SOM using a distance preserving map projection. This provides a clearer picture of similarity/dissimilarity among SOM profiles. 

```{r somfitplots, echo=TRUE}
sommix_eval(sommod, labtype = "XYs", legcex=0.75)
```

###Assessing Variable Importance

```{r compeval, echo=TRUE}
compeval(summ)
```

Future vignettes will illustrate how to integrate SOM results in linear and generalized modeling frameworks. 
